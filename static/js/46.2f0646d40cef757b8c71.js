webpackJsonp([46],{OIHO:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=a("ZLEe"),r=a.n(s),i=a("lC5x"),l=a.n(i),n=a("J0Oq"),o=a.n(n),d={name:"matching",data:function(){return{treeLoading:!0,addrLoading:!1,addrOption:[],token:localStorage.getItem("token"),imageUrl:"",userList:[],userType:Number(localStorage.getItem("wuyuanUserType")),submitType:"add",nodeList:[],currentNode:{data:{list:[]}},data:[],detailRow:{},defaultExpanded:[],defaultChecked:[],rootNode:"",unBindOrg:[],addNodeVisible:!1,detailVisible:!1,defaultProps:{children:"list",label:"organizationName"},casProps:{children:"list",label:"organizationName",value:"id"},rules:{name:[{required:!0,message:"请填入组织名称",trigger:"blur"},{validator:function(e,t,a){commonUtils.regExp.noSpecialChar(t)?a():a("不能有特殊字符")},trigger:"blur"}],code:[{required:!0,message:"请填入组织编号",trigger:"blur"}],tel:[{required:!0,message:"请填入手机号",trigger:"blur"},{validator:function(e,t,a){0==/^1[34578]\d{9}$/.test(t)?a(new Error("请输入正确的手机号")):a()},trigger:"blur"}],remark:[]},ruleForm:{name:"",code:"",addr:"",principal:"",tel:"",remark:"",parentId:[],papersUrl:""},options:[],epcData:{},choicedAddress:{},addrObj:{}}},computed:{},created:function(){},mounted:function(){var e=this;this.getUserList().then(function(){e.$RequestUtil.post({url:"/user/org/getOrganizationList",params:{},success:function(t){e.nodeList=t.data.list,e.rootNode=t.data.organizationId,e.init(e.data,t.data.list,t.data.organizationId),e.data.forEach(function(a){null==a.parentId?e.loadOrg(a,a.id,t.data.list):e.loadOrg(a,t.data.organizationId,t.data.list)}),e.defaultExpanded=[t.data.organizationId],e.defaultChecked=[t.data.organizationId],t.data.organizationId&&e.$nextTick(function(e){this.$refs.tree.setCurrentKey(t.data.organizationId),this.currentNode=this.$refs.tree.getNode(t.data.organizationId)}),e.treeLoading=!1}})})},methods:{checkAdressLength:function(e){return commonUtils.placeholderLength(e)>16},beforeUpload:function(e){if(e.size>1048576)return this.$message.error("文件不能大于1M"),!1},handleAvatarSuccess:function(e,t){this.ruleForm.papersUrl=e.data.url,this.imageUrl=URL.createObjectURL(t.raw)},removeImg:function(){this.ruleForm.papersUrl="",this.imageUrl=""},getUserList:function(){var e=this;return o()(l.a.mark(function t(){return l.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.$RequestUtil.post({url:"/user/user/getUserList",params:{},success:function(t){e.userList=t.data,e.userList.forEach(function(t){"EPC管理员"==t.roleName&&(e.epcData=t)})}});case 2:case"end":return t.stop()}},t,e)}))()},init:function(e,t,a){t.forEach(function(t){t.id!=a&&null!=t.parentId||(t.list=[],e.push(t))})},loadOrg:function(e,t,a){var s=this;a.forEach(function(i){if(i.parentId==t){r()(e).includes("list")||(e.list=[]);var l=e.list;l.push(i),s.loadOrg(l[l.length-1],i.id,a)}})},reload:function(e,t){var a=this;this.$RequestUtil.post({url:"/user/org/getOrganizationList",params:{},success:function(s){a.data=[],a.nodeList=s.data.list,a.init(a.data,s.data.list,s.data.organizationId),a.data.forEach(function(e){null==e.parentId?a.loadOrg(e,e.id,s.data.list):a.loadOrg(e,s.data.organizationId,s.data.list)}),2!=a.userType||t||0==a.data.length||localStorage.setItem("wuyuanUserOrgCode",a.data[0].organizationCode),0!==s.data.list.length&&null!=t&&(a.defaultExpanded=[s.data.organizationId,e],a.$nextTick(function(e){a.currentNode=a.$refs.tree.getNode(t),a.$refs.tree.setCurrentKey(t)}))}})},handleClose:function(){this.$refs.addForm.resetFields(),this.ruleForm.parentId=[],this.loadUnBindOrg(0)},clear:function(){this.$refs.addForm.resetFields(),this.currentNode={data:{list:[]}}},loadUnBindOrg:function(e){var t=this;this.options=[],this.ruleForm.nodeName="",this.ruleForm.is_min="",2==e&&(this.ruleForm.is_min=0),this.nodeName="",this.unBindOrg.forEach(function(a){a.type==e&&t.options.push(a)})},currentParents:function(e){this.ruleForm.parentId.unshift(e.data.id),1!=e.level&&this.currentParents(e.parent)},ergodicUpperList:function(e,t){for(var a in t){if(t[a].disabled=!1,t[a].id==e)return void(t[a].disabled=!0);t[a].list&&this.ergodicUpperList(e,t[a].list)}},editNode:function(){var e=this;this.ruleForm.parentId=[],this.imageUrl=this.currentNode.data.papersUrl,this.addNodeVisible=!0,this.$nextTick(function(){e.currentParents(e.currentNode),e.ergodicUpperList(e.currentNode.data.id,e.data),e.ruleForm.parentId.pop(),e.ruleForm.name=e.currentNode.data.organizationName,e.ruleForm.principal=e.currentNode.data.principal,e.ruleForm.remark=e.currentNode.data.remark,e.ruleForm.addr=e.currentNode.data.address,e.addrObj.address=e.currentNode.data.address,e.addrObj.longitude="",e.addrObj.latitude="",e.submitType="edit"})},addNode:function(){this.imageUrl="",this.submitType="add",null!=this.currentNode&&null!=this.currentNode.data.id?(this.currentParents.call(this,this.currentNode),this.addNodeVisible=!0):2===this.userType&&0===this.data.length?this.addNodeVisible=!0:(this.$message({message:"当前未选择组织",type:"warning"}),this.addNodeVisible=!1)},sureAdd:function(){var e=this;this.$refs.addForm.validate(function(t){if(!t)return!1;var a={organizationName:e.ruleForm.name,principal:e.ruleForm.principal,address:e.choicedAddress,tel:e.ruleForm.tel,remark:e.ruleForm.remark,parentId:e.currentNode.data.id,organizationCode:e.currentNode.data.organizationCode,papersUrl:e.ruleForm.papersUrl},s="/user/org/addOrganization";"edit"==e.submitType&&(a.id=e.currentNode.data.id,s="/user/org/updateOrganization",a.parentId=e.ruleForm.parentId[e.ruleForm.parentId.length-1]);var r=void 0;0==e.nodeList.length?(a.parentId=null,a.principal=localStorage.getItem("wuyuanIotUserId"),r=null):r=e.currentNode.data.id,e.$RequestUtil.postSync({url:s,params:a,success:function(t){"success"==t.result?(e.$message({type:"success",message:t.msg}),e.reload(a.parentId,r),e.$nextTick(function(t){return e.addNodeVisible=!1})):"fail"==t.result&&e.$message({type:"error",message:t.msg})}})})},delNode:function(){var e=this;null!=this.currentNode.data.id?null!=this.$refs.tree.getCurrentNode()?this.$RequestUtil.post({url:"/user/org/getOrgAndUserNum",params:{id:this.$refs.tree.getCurrentNode().id},success:function(t){if(t.data.staffNum>0)e.$confirm("该组织下有"+t.data.orgNum+"个子组织"+t.data.staffNum+"个成员,请先解除关系，再删除！","提示",{showConfirmButton:!1,cancelButtonText:"确定",type:"warning"}).catch(function(e){});else{var a=0!=e.currentNode.childNodes.length?"该组织下还有子组织，确认删除？":"确认删除?";e.$confirm(a,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){e.$RequestUtil.post({url:"/user/org/deleteOrganization",params:{id:e.$refs.tree.getCurrentNode().id,organizationCode:e.$refs.tree.getCurrentNode().organizationCode},success:function(t){e.currentNode={data:{list:[]}},e.$message({type:"success",message:t.msg}),e.reload(e.$refs.tree.getCurrentNode().parentId,e.$refs.tree.getCurrentNode().parentId)}})}).catch(function(e){})}}}):(this.$message({message:"当前未选择组织",type:"warning"}),this.addNodeVisible=!1):this.$message({message:"当前未选择组织",type:"warning"})},nodeChange:function(e,t){this.currentNode=t}}},c={render:function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"matching list-window",staticStyle:{height:"100%"}},[a("el-row",{staticClass:"list-div-flex",attrs:{type:"flex"}},[a("el-col",{staticClass:"col-style",attrs:{span:5}},[e.$PERMISSION.ORG_WRITE?a("div",{staticClass:"org-style-btn"},[a("el-button",{attrs:{type:"primary",size:"small"},on:{click:e.addNode}},[e._v("新增组织")]),e._v(" "),a("el-button",{attrs:{plain:"",size:"small"},on:{click:e.delNode}},[e._v("删除组织")])],1):e._e(),e._v(" "),a("div",{staticClass:"allOrglists"},[a("el-tree",{directives:[{name:"loading",rawName:"v-loading",value:e.treeLoading,expression:"treeLoading"}],ref:"tree",staticClass:"list-div",attrs:{"highlight-current":!0,"expand-on-click-node":!1,"default-expanded-keys":e.defaultExpanded,"default-checked-keys":e.defaultChecked,data:e.data,props:e.defaultProps,"node-key":"id"},on:{"current-change":e.nodeChange}})],1)]),e._v(" "),a("el-col",{staticClass:"orgBody",attrs:{span:18}},[a("div",{directives:[{name:"show",rawName:"v-show",value:e.currentNode.data.id,expression:"currentNode.data.id"}]},[a("p",{staticClass:"style-p"},[e._v(e._s(e.currentNode.label))]),e._v(" "),a("br"),e._v(" "),e.$PERMISSION.ORG_WRITE?a("el-button",{attrs:{type:"primary",size:"mini"},on:{click:e.editNode}},[e._v("编辑")]):e._e(),e._v(" "),a("br"),e._v(" "),a("p",{staticClass:"p-class"},[e._v("负责人："),a("span",{staticClass:"s-class"},[e._v(e._s(e.currentNode.data.nickName))])]),e._v(" "),a("p",{staticClass:"p-class"},[e._v("手机号："),a("span",{staticClass:"s-class"},[e._v(e._s(e.currentNode.data.userTel))])]),e._v(" "),a("div",{staticClass:"down-org-style"}),e._v(" "),a("h4",[e._v("下级组织：")]),e._v(" "),a("br"),e._v(" "),a("el-scrollbar",{staticStyle:{height:"400px"}},[a("el-table",{staticClass:"orgNext",attrs:{data:e.currentNode.data.list}},[a("el-table-column",{attrs:{label:"名称","min-width":"180",formatter:function(e){return e.name}},scopedSlots:e._u([{key:"default",fn:function(t){return[a("div",{staticClass:"firstColumn"},[e._v(e._s(t.row.organizationName))])]}}])}),e._v(" "),a("el-table-column",{attrs:{prop:"nickName",label:"负责人"}}),e._v(" "),a("el-table-column",{attrs:{prop:"userTel",label:"手机号"}}),e._v(" "),a("el-table-column",{attrs:{label:"操作",width:"80"},scopedSlots:e._u([{key:"default",fn:function(t){return[a("el-button",{attrs:{type:"text"},on:{click:function(){e.detailVisible=!0,e.detailRow=t.row}}},[e._v("详情")])]}}])})],1)],1)],1)])],1),e._v(" "),a("el-dialog",{attrs:{"close-on-click-modal":!1,title:"详情",visible:e.detailVisible,width:"650px"},on:{"update:visible":function(t){e.detailVisible=t}}},[a("el-row",[a("el-col",{attrs:{span:12,offset:2}},[a("div",{staticClass:"detail__line"},[a("el-row",[a("el-col",{staticClass:"span-col-class",attrs:{span:7}},[e._v("组织名称：")]),e._v(" "),a("el-col",{staticClass:"span-info-class",attrs:{span:17}},[e._v(e._s(e.detailRow.organizationName))])],1)],1),e._v(" "),a("div",{staticClass:"detail__line"},[a("el-row",[a("el-col",{staticClass:"span-col-class",attrs:{span:7}},[e._v("组织编号：")]),e._v(" "),a("el-col",{staticClass:"span-info-class",attrs:{span:17}},[e._v(e._s(e.detailRow.organizationCode))])],1)],1),e._v(" "),a("div",{staticClass:"detail__line"},[a("el-row",[a("el-col",{staticClass:"span-col-class",attrs:{span:7}},[e._v("负责人：")]),e._v(" "),a("el-col",{staticClass:"span-info-class",attrs:{span:17}},[e._v(e._s(e.detailRow.nickName))])],1)],1),e._v(" "),a("div",{staticClass:"detail__line"},[a("el-row",[a("el-col",{staticClass:"span-col-class",attrs:{span:7}},[e._v("负责人手机：")]),e._v(" "),a("el-col",{staticClass:"span-info-class",attrs:{span:17}},[e._v(e._s(e.detailRow.userTel))])],1)],1),e._v(" "),a("div",{staticClass:"detail__line"},[a("el-row",[a("el-col",{staticClass:"span-col-class",attrs:{span:7}},[e._v("地址：")]),e._v(" "),a("el-col",{staticClass:"span-info-class",attrs:{span:17}},[e._v(e._s(e.detailRow.address))])],1)],1),e._v(" "),a("div",{staticClass:"detail__line"},[a("el-row",[a("el-col",{staticClass:"span-col-class",attrs:{span:7}},[e._v("备注：")]),e._v(" "),a("el-col",{staticClass:"span-info-class",attrs:{span:17}},[a("textareaCheckRows",{attrs:{"input-type":"pre",ellipsis:!1,"row-class":"text","text-value":e.detailRow.remark}})],1)],1)],1)]),e._v(" "),a("el-col",{attrs:{span:10}},[a("div",{staticClass:"img"},[e.detailRow.papersUrl?a("img",{staticStyle:{width:"100%",height:"100%"},attrs:{src:e.detailRow.papersUrl,alt:""}}):e._e()])])],1)],1),e._v(" "),a("el-dialog",{attrs:{"close-on-click-modal":!1,title:"edit"!=e.submitType?"新增组织":"编辑组织",visible:e.addNodeVisible,width:"600px"},on:{"update:visible":function(t){e.addNodeVisible=t},close:e.handleClose}},[a("el-form",{ref:"addForm",attrs:{"label-width":"100px",model:e.ruleForm,rules:e.rules}},[a("el-row",[a("el-col",{attrs:{span:11}},[a("el-form-item",{staticClass:"el-inputcss",attrs:{label:"组织名称：",prop:"name"}},[a("el-input",{attrs:{maxlength:"50",placeholder:"请输入组织名称"},model:{value:e.ruleForm.name,callback:function(t){e.$set(e.ruleForm,"name",t)},expression:"ruleForm.name"}})],1),e._v(" "),a("el-form-item",{staticClass:"el-inputcss",attrs:{label:"负责人：",prop:"principal"}},[a("el-select",{attrs:{placeholder:"请选择负责人"},model:{value:e.ruleForm.principal,callback:function(t){e.$set(e.ruleForm,"principal",t)},expression:"ruleForm.principal"}},e._l(e.userList,function(e){return a("el-option",{key:e.id,attrs:{label:e.nickName,value:e.id}})}),1)],1),e._v(" "),0==e.nodeList.length||0==e.ruleForm.parentId.length?a("el-form-item",{staticClass:"el-inputcss",attrs:{label:"地址：",prop:"addr"}},[a("addressChoice",{attrs:{"ori-data":e.addrObj,model:e.ruleForm.addr,"ori-addr":e.choicedAddress},on:{"update:model":function(t){return e.$set(e.ruleForm,"addr",t)},"update:oriAddr":function(t){e.choicedAddress=t},"update:ori-addr":function(t){e.choicedAddress=t}}})],1):e._e(),e._v(" "),a("el-form-item",{staticClass:"el-inputcss",attrs:{label:"备注：",prop:"remark"}},[a("el-input",{attrs:{type:"textarea",rows:3,placeholder:"请输入内容（不得超过255字）",maxlength:"255"},model:{value:e.ruleForm.remark,callback:function(t){e.$set(e.ruleForm,"remark",t)},expression:"ruleForm.remark"}})],1)],1),e._v(" "),a("el-col",{attrs:{span:11,offset:2}},[a("el-upload",{staticClass:"uploader",attrs:{accept:".png, .jpg,.bmp,.gif","show-file-list":!1,action:"wuyuan/upload/uploadPicture","before-upload":e.beforeUpload,data:{pictureType:"organization"},"on-success":e.handleAvatarSuccess,headers:{Authorization:"Bearer "+e.token}}},[a("el-button",{attrs:{size:"mini",type:"primary"}},[e._v("上传图片")]),e._v(" "),a("div",{staticClass:"el-upload__tip",attrs:{slot:"tip"},slot:"tip"},[e._v("不超过1M")])],1),e._v(" "),a("div",{staticClass:"img el-upload-list--picture-card "},[e.imageUrl?a("img",{staticStyle:{width:"100%",height:"100%"},attrs:{src:e.imageUrl,alt:""}}):e._e(),e._v(" "),e.imageUrl?a("span",{staticClass:"el-upload-list__item-actions"},[a("span",{staticClass:"el-upload-list__item-delete",on:{click:e.removeImg}},[a("i",{staticClass:"el-icon-delete"})])]):e._e()])],1)],1)],1),e._v(" "),a("span",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[a("el-button",{attrs:{type:"primary"},on:{click:e.sureAdd}},[e._v("确 定")])],1)],1)],1)},staticRenderFns:[]};var u=a("C7Lr")(d,c,!1,function(e){a("Xl2O")},"data-v-4103fce0",null);t.default=u.exports},Xl2O:function(e,t){}});